# Starter pipeline
# Start with a minimal pipeline that you can customize to build and deploy your code.
# Add steps that build, run tests, deploy, and more:
# https://aka.ms/yaml

trigger:
- test-azure

variables:
  npm_config_runtime: ''
  npm_config_target: ''
  npm_config_disturl: ''

strategy:
  matrix:
    linux_node_8_x:
      image_name: 'ubuntu-16.04'
      node_version: 8.x
    linux_node_10_x:
      image_name: 'ubuntu-16.04'
      node_version: 10.x
    linux_node_11_x:
      image_name: 'ubuntu-16.04'
      node_version: 11.x
    linux_electron_2_x:
      image_name: 'ubuntu-16.04'
      node_version: 8.x
      npm_config_runtime: 'electron'
      npm_config_target: '2.0.17'
      npm_config_disturl: 'https://atom.io/download/electron'
    linux_electron_4_x:
      image_name: 'ubuntu-16.04'
      node_version: 10.x
      npm_config_runtime: 'electron'
      npm_config_target: '4.0.6'
      npm_config_disturl: 'https://atom.io/download/electron'
    macOS_node_8_x:
      image_name: 'macos-10.13'
      node_version: 8.x
    macOS_node_10_x:
      image_name: 'macos-10.13'
      node_version: 10.x
    macOS_node_11_x:
      image_name: 'macos-10.13'
      node_version: 11.x
    macOS_electron_2_x:
      image_name: 'macos-10.13'
      node_version: 8.x
      npm_config_runtime: 'electron'
      npm_config_target: '2.0.17'
      npm_config_disturl: 'https://atom.io/download/electron'
    macOS_electron_4_x:
      image_name: 'macos-10.13'
      node_version: 10.x
      npm_config_runtime: 'electron'
      npm_config_target: '4.0.6'
      npm_config_disturl: 'https://atom.io/download/electron'
    win64_node_8_x:
      image_name: 'vs2017-win2016'
      node_version: 8.x
    win64_node_10_x:
      image_name: 'vs2017-win2016'
      node_version: 10.x
    win64_node_11_x:
      image_name: 'vs2017-win2016'
      node_version: 11.x
    win32_node_8_x:
      image_name: 'vs2017-win2016'
      node_version: 8.x
      node_arch: '32'
    win32_node_10_x:
      image_name: 'vs2017-win2016'
      node_version: 10.x
      node_arch: '32'
    win32_node_11_x:
      image_name: 'vs2017-win2016'
      node_version: 11.x
      node_arch: '32'

pool:
  vmImage: $(image_name)

steps:
- task: NodeTool@0
  inputs:
    versionSpec: $(node_version)
  displayName: 'Install Node.js $(node_version)'
- script: |
    choco install -y nvm
    set NVM_HOME="C:\ProgramData\nvm"
    set NVM_SYMLINK="C:\Program Files\nodejs"
    set PATH=$PATH:$NVM_HOME:$NVM_SYMLINK
    nvm install $NODE_VERSION $NODE_ARCH
    nvm use $NODE_VERSION $NODE_ARCH
  condition: and(contains(variables['image_name'], 'win'), eq(variables['node_arch'], '32'))
  displayName: 'Install Node.js 32-bit'
- script: |
    node -v
    npm i --build-from-source
    npm run package-prebuilt
    npm run publish-prebuilt
  env: {
    NODE_VERSION: $(node_version),
    NODE_ARCH: $(node_arch),
    npm_config_runtime: $(npm_config_runtime),
    npm_config_target: $(npm_config_target),
    npm_config_disturl: $(npm_config_disturl),
    NODE_PRE_GYP_GITHUB_TOKEN: $(chun_github_token)
  }
